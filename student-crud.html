<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ğŸ“¦ Dunder Mifflin Paper Orders</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
</head>
<body>
  <div class="container mt-5">
    <h1 class="text-center mb-4">ğŸ“„ Dunder Mifflin Paper Ordering System</h1>

    <!-- Management Section -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card bg-light">
          <div class="card-body text-center">
            <h5 class="card-title">ğŸ› ï¸ Order Management</h5>
            <button class="btn btn-success me-2" onclick="seedDatabase()">ğŸŒ± Seed Sample Orders</button>
            <button class="btn btn-danger" onclick="cleanupDatabase()">ğŸ§¹ Clear All Orders</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Place New Order -->
    <div class="row mb-4">
      <div class="col-md-6">
        <div class="card">
          <div class="card-header"><h5>ğŸ›’ Place New Order</h5></div>
          <div class="card-body">
            <form id="addOrderForm">
              <div class="mb-3">
                <label for="paperType" class="form-label">Paper Type</label>
                <input type="text" class="form-control" id="paperType" required placeholder="e.g. Glossy, Matte" />
              </div>
              <div class="mb-3">
                <label for="quantity" class="form-label">Quantity (in reams)</label>
                <input type="number" class="form-control" id="quantity" required min="1" />
              </div>
              <div class="mb-3">
                <label for="salesperson" class="form-label">Salesperson</label>
                <select class="form-select" id="salesperson" required>
                  <option value="">Choose a character</option>
                  <option value="Jim Halpert">Jim Halpert</option>
                  <option value="Dwight Schrute">Dwight Schrute</option>
                  <option value="Pam Beesly">Pam Beesly</option>
                  <option value="Michael Scott">Michael Scott</option>
                  <option value="Stanley Hudson">Stanley Hudson</option>
                </select>
              </div>
              <button type="submit" class="btn btn-primary">Place Order</button>
            </form>
          </div>
        </div>
      </div>

      <!-- Update Order -->
      <div class="col-md-6">
        <div class="card">
          <div class="card-header"><h5>âœï¸ Update Order</h5></div>
          <div class="card-body">
            <form id="updateOrderForm">
              <div class="mb-3">
                <label for="updateId" class="form-label">Order ID</label>
                <input type="text" class="form-control" id="updateId" readonly required />
              </div>
              <div class="mb-3">
                <label for="updatePaperType" class="form-label">Paper Type</label>
                <input type="text" class="form-control" id="updatePaperType" required />
              </div>
              <div class="mb-3">
                <label for="updateQuantity" class="form-label">Quantity</label>
                <input type="number" class="form-control" id="updateQuantity" required min="1" />
              </div>
              <div class="mb-3">
                <label for="updateSalesperson" class="form-label">Salesperson</label>
                <select class="form-select" id="updateSalesperson" required>
                  <option value="Jim Halpert">Jim Halpert</option>
                  <option value="Dwight Schrute">Dwight Schrute</option>
                  <option value="Pam Beesly">Pam Beesly</option>
                  <option value="Michael Scott">Michael Scott</option>
                  <option value="Stanley Hudson">Stanley Hudson</option>
                </select>
              </div>
              <button type="submit" class="btn btn-warning">Update Order</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Orders List -->
    <div class="row">
      <div class="col-12">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5>ğŸ“¦ All Orders</h5>
            <button class="btn btn-info btn-sm" onclick="loadOrders()">ğŸ”„ Refresh</button>
          </div>
          <div class="card-body">
            <div id="ordersList">
              <p class="text-muted">Click "Refresh" to load orders...</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Messages -->
    <div id="messages" class="mt-3"></div>
  </div>

  <!-- Bootstrap Bundle JS (with Popper) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    function showMessage(message, type = "info") {
      const messagesDiv = document.getElementById("messages");
      messagesDiv.innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>`;
      setTimeout(() => { messagesDiv.innerHTML = ""; }, 5000);
    }

    // CREATE
    document.getElementById("addOrderForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const order = {
        paperType: document.getElementById("paperType").value.trim(),
        quantity: parseInt(document.getElementById("quantity").value),
        salesperson: document.getElementById("salesperson").value,
      };

      try {
        const res = await fetch("/api/orders", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(order),
        });

        const result = await res.json();
        if (res.ok) {
          showMessage(`âœ… Order for "${order.paperType}" placed!`, "success");
          document.getElementById("addOrderForm").reset();
          loadOrders();
        } else {
          showMessage(`âŒ ${result.error || "Failed to create order"}`, "danger");
        }
      } catch (err) {
        showMessage(`âŒ Network error: ${err.message}`, "danger");
      }
    });

    // READ
    async function loadOrders() {
      try {
        const res = await fetch("/api/orders");
        const orders = await res.json();
        const ordersList = document.getElementById("ordersList");

        if (!Array.isArray(orders) || orders.length === 0) {
          ordersList.innerHTML = '<p class="text-muted">No orders yet. Try placing one!</p>';
          return;
        }

        ordersList.innerHTML = orders.map(order => `
          <div class="card mb-2">
            <div class="card-body d-flex justify-content-between align-items-center">
              <div>
                <strong>${order.paperType}</strong> â€” ${order.quantity} reams<br />
                <small>Salesperson: ${order.salesperson}</small><br />
                <small class="text-muted">
                  ID: <span 
                        class="order-id" 
                        style="cursor: pointer; text-decoration: underline;" 
                        data-id="${order._id}" 
                        data-paper="${order.paperType}" 
                        data-quantity="${order.quantity}" 
                        data-salesperson="${order.salesperson}">
                      ${order._id || "N/A"}
                  </span>
                </small>
              </div>
              <div>
                <button class="btn btn-sm btn-outline-danger me-2 delete-btn" data-id="${order._id}" data-paper="${order.paperType}">
                  ğŸ—‘ï¸
                </button>
                <button class="btn btn-sm btn-outline-secondary reorder-btn" data-paper="${order.paperType}" data-quantity="${order.quantity}" data-salesperson="${order.salesperson}">
                  ğŸ” Reorder
                </button>
              </div>
            </div>
          </div>
        `).join("");

        // Populate update form on ID click
        document.querySelectorAll(".order-id").forEach(el => {
          el.addEventListener("click", () => {
            const id = el.dataset.id;
            const paper = el.dataset.paper;
            const quantity = el.dataset.quantity;
            const salesperson = el.dataset.salesperson;
            fillUpdateForm(id, paper, quantity, salesperson);
          });
        });

        // Delete buttons
        document.querySelectorAll(".delete-btn").forEach(btn => {
          btn.addEventListener("click", () => {
            const id = btn.dataset.id;
            const paper = btn.dataset.paper;
            deleteOrder(id, paper);
          });
        });

        // Reorder buttons
        document.querySelectorAll(".reorder-btn").forEach(btn => {
          btn.addEventListener("click", () => {
            const paper = btn.dataset.paper;
            const quantity = btn.dataset.quantity;
            const salesperson = btn.dataset.salesperson;
            fillNewOrderForm(paper, quantity, salesperson);
            showMessage("ğŸ” Loaded previous order into form. You can modify and submit.", "info");
          });
        });

        showMessage(`ğŸ“¦ Loaded ${orders.length} orders.`, "info");
      } catch (err) {
        showMessage(`âŒ Error loading orders: ${err.message}`, "danger");
      }
    }

    // Fill Update Form
    function fillUpdateForm(id, paper, quantity, salesperson) {
      document.getElementById("updateId").value = id;
      document.getElementById("updatePaperType").value = paper;
      document.getElementById("updateQuantity").value = quantity;
      document.getElementById("updateSalesperson").value = salesperson;
      showMessage("âœï¸ Order loaded into update form.", "info");
    }

    // Fill New Order Form for Reorder
    function fillNewOrderForm(paper, quantity, salesperson) {
      document.getElementById("paperType").value = paper;
      document.getElementById("quantity").value = quantity;
      document.getElementById("salesperson").value = salesperson;
    }

    // UPDATE
    document.getElementById("updateOrderForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const id = document.getElementById("updateId").value;
      const updatedOrder = {
        paperType: document.getElementById("updatePaperType").value.trim(),
        quantity: parseInt(document.getElementById("updateQuantity").value),
        salesperson: document.getElementById("updateSalesperson").value,
      };

      try {
        const res = await fetch(`/api/orders/${id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(updatedOrder),
        });

        const result = await res.json();
        if (res.ok) {
          showMessage(`âœï¸ Order ${id} updated!`, "success");
          document.getElementById("updateOrderForm").reset();
          loadOrders();
        } else {
          showMessage(`âŒ ${result.error || "Failed to update order"}`, "danger");
        }
      } catch (err) {
        showMessage(`âŒ Network error: ${err.message}`, "danger");
      }
    });

    // DELETE
    async function deleteOrder(id, paperType) {
      if (!confirm(`ğŸ—‘ï¸ Are you sure you want to delete order for "${paperType}"?`)) return;

      try {
        const res = await fetch(`/api/orders/${id}`, { method: "DELETE" });
        const result = await res.json();

        if (res.ok) {
          showMessage(`ğŸ—‘ï¸ Deleted order for "${paperType}".`, "success");
          loadOrders();
        } else {
          showMessage(`âŒ ${result.error || "Failed to delete order"}`, "danger");
        }
      } catch (err) {
        showMessage(`âŒ Network error: ${err.message}`, "danger");
      }
    }

    // SEED SAMPLE DATA
    async function seedDatabase() {
      const sampleOrders = [
        { paperType: "Glossy", quantity: 10, salesperson: "Jim Halpert" },
        { paperType: "Matte", quantity: 5, salesperson: "Dwight Schrute" },
        { paperType: "Recycled", quantity: 20, salesperson: "Pam Beesly" },
        { paperType: "Cardstock", quantity: 15, salesperson: "Michael Scott" },
        { paperType: "Photo Paper", quantity: 7, salesperson: "Stanley Hudson" },
      ];

      try {
        for (const order of sampleOrders) {
          await fetch("/api/orders", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(order),
          });
        }
        showMessage("ğŸŒ± Sample orders seeded.", "success");
        loadOrders();
      } catch (err) {
        showMessage(`âŒ Failed to seed database: ${err.message}`, "danger");
      }
    }

    // CLEAR ALL ORDERS
    async function cleanupDatabase() {
      if (!confirm("ğŸ§¹ This will delete ALL orders permanently. Continue?")) return;

      try {
        const res = await fetch("/api/orders", { method: "DELETE" });
        const result = await res.json();

        if (res.ok) {
          showMessage("ğŸ§¹ All orders cleared.", "success");
          loadOrders();
        } else {
          showMessage(`âŒ ${result.error || "Failed to clear orders"}`, "danger");
        }
      } catch (err) {
        showMessage(`âŒ Network error: ${err.message}`, "danger");
      }
    }

    // Initial load
    loadOrders();
  </script>
</body>
</html>
